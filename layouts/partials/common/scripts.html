<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@11.9.0/dist/mermaid.min.js"></script>
<script>hljs.highlightAll();</script>

<!-- Alpine.js -->
<script src="//unpkg.com/alpinejs" defer></script>
<style>
  [x-cloak] { display: none !important; }
</style>

<script>
document.addEventListener('alpine:init', () => {

  Alpine.store('theme', {
    dark: false,
    switcherOpen: false,
    system: false,
    init() {
      const savedTheme = localStorage.getItem('theme');
      const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (savedTheme === 'dark') {
        this.dark = true;
      } else if (savedTheme === 'light') {
        this.dark = false;
      } else if (savedTheme === 'system') {
        this.system = true;
        this.dark = systemPrefersDark;
      } else {
        this.system = true;
        this.dark = systemPrefersDark;
      }
      this.applyTheme();
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        if (this.system) {
          this.dark = e.matches;
          this.applyTheme();
        }
      });
    },
    setTheme(theme) {
      if (theme === 'dark') {
        this.dark = true;
        this.system = false;
        localStorage.setItem('theme', 'dark');
      } else if (theme === 'light') {
        this.dark = false;
        this.system = false;
        localStorage.setItem('theme', 'light');
      } else {
        this.system = true;
        this.dark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        localStorage.setItem('theme', 'system');
      }
      this.applyTheme();
    },
    applyTheme() {
      if (this.dark) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    }
  });

  // âœ… Panggil init di sini
  Alpine.store('search').init();
});
</script>

<script src="{{ "js/fuse.min.js" | relURL }}"></script>
<script src="{{ "js/lucide.min.js" | relURL }}"></script>
<script>
  const searchToggle = document.getElementById('searchToggle');
  const searchModal = document.getElementById('searchModal');
  const searchClose = document.getElementById('searchClose');
  const searchCloseBtn = document.getElementById('searchCloseBtn');
  const searchInput = document.getElementById("searchInput");
  const searchResults = document.getElementById("searchResults");
  let fuse, fuseIndex = [];

  fetch("/index.json")
    .then(res => res.json())
    .then(data => {
      fuseIndex = data;
      fuse = new Fuse(fuseIndex, { keys: ["title", "content"], threshold: 0.3 });
    });

  searchToggle?.addEventListener('click', () => {
    searchModal.classList.remove('hidden');
    setTimeout(() => {
      searchInput.focus();
      lucide.createIcons();
    }, 100);
  });

  [searchClose, searchCloseBtn].forEach(el => el?.addEventListener('click', () => {
    searchModal.classList.add('hidden');
    searchInput.value = '';
    searchResults.innerHTML = '';
  }));

  searchInput?.addEventListener('input', () => {
    const query = searchInput.value.trim();
    if (!query || !fuse) return searchResults.innerHTML = '';
    const results = fuse.search(query).slice(0, 8);
    searchResults.innerHTML = results.length
      ? results.map(r => `
          <li>
            <a href="${r.item.permalink}" class="block p-2 rounded-md text-white-100 hover:bg-teal-700 hover:text-white focus:outline-none focus:ring-2 focus:ring-teal-500">
              <strong>${r.item.title}</strong><br>
              <small>${r.item.content.slice(0, 80)}...</small>
            </a>
          </li>`).join('')
      : '<li class="text-gray-500 dark:text-gray-400">Tidak ada hasil ditemukan.</li>';
  });

  document.addEventListener('keydown', e => {
    if (e.key === "Escape") searchModal.classList.add('hidden');
  });
</script>

<script>
  const scrollToTopBtn = document.getElementById('scrollToTopBtn');

  window.addEventListener('scroll', () => {
    if (window.scrollY > 100) {
      scrollToTopBtn.classList.remove('hidden');
    } else {
      scrollToTopBtn.classList.add('hidden');
    }
  });

  scrollToTopBtn?.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  document.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();
  });
</script>

<script>
/**
 * Tab System for Hugo Shortcodes
 */
function switchTab(button, tabId) {
  const tabContainer = button.closest('.simple-tabs');
  
  // Nonaktifkan semua button dan content
  tabContainer.querySelectorAll('.tab-button').forEach(btn => {
    btn.classList.remove('active');
  });
  tabContainer.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  
  // Aktifkan yang dipilih
  button.classList.add('active');
  document.getElementById(tabId).classList.add('active');
}
</script>

<script>
/* Auto-add copy buttons to all pre > code blocks */
document.addEventListener('DOMContentLoaded', () => {
  const createCopyButton = (pre) => {
    if (pre.querySelector('.copy-btn') || !pre.querySelector('code')) return;

    const copyBtn = document.createElement('button');
    copyBtn.className = 'copy-btn absolute top-2 right-2 text-xs px-2 py-1 bg-slate-700 hover:bg-slate-600 text-white rounded opacity-0 transition-all duration-200';
    copyBtn.innerHTML = '<i class="fas fa-copy" aria-hidden="true"></i>';
    copyBtn.setAttribute('aria-label', 'Copy code');
    copyBtn.setAttribute('title', 'Copy to clipboard');

    copyBtn.addEventListener('click', async () => {
      try {
        const code = pre.querySelector('code').textContent.trim();
        await navigator.clipboard.writeText(code);
        
        copyBtn.innerHTML = '<i class="fas fa-check" aria-hidden="true"></i>';
        copyBtn.classList.add('bg-green-500', 'hover:bg-green-600');
        
        setTimeout(() => {
          copyBtn.innerHTML = '<i class="fas fa-copy" aria-hidden="true"></i>';
          copyBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
        }, 2000);
      } catch (err) {
        copyBtn.innerHTML = '<i class="fas fa-times" aria-hidden="true"></i>';
        copyBtn.classList.add('bg-red-500', 'hover:bg-red-600');
        setTimeout(() => {
          copyBtn.innerHTML = '<i class="fas fa-copy" aria-hidden="true"></i>';
          copyBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
        }, 2000);
      }
    });

    pre.style.position = 'relative';
    pre.appendChild(copyBtn);

    pre.addEventListener('mouseenter', () => copyBtn.classList.remove('opacity-0'));
    pre.addEventListener('mouseleave', () => {
      if (!copyBtn.innerHTML.includes('check')) {
        copyBtn.classList.add('opacity-0');
      }
    });
  };

  // Initialize for existing code blocks
  document.querySelectorAll('pre').forEach(createCopyButton);

  // Handle dynamically loaded content (e.g., tabs, AJAX)
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      mutation.addedNodes.forEach((node) => {
        if (node.nodeType === 1) { // Element node
          if (node.matches('pre')) createCopyButton(node);
          node.querySelectorAll?.('pre').forEach(createCopyButton);
        }
      });
    });
  });

  observer.observe(document.body, { childList: true, subtree: true });
});
</script>
